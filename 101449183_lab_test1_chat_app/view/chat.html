<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    #messages { height: 420px; overflow-y: auto; background: #fff; }
    .msg { padding: 10px 12px; border-radius: 10px; margin-bottom: 8px; background: #f5f5f5; }
    .msg.me { background: #e8f3ff; }
    .meta { font-size: 12px; opacity: 0.7; margin-bottom: 3px; }
    .typing { font-size: 12px; opacity: 0.8; }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4" style="max-width: 980px;">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h3 class="m-0">Chat app</h3>
        <div class="text-muted small">Room: <span id="roomName"></span></div>
      </div>
      <div class="d-flex gap-2">
        <button id="leaveBtn" class="btn btn-outline-secondary btn-sm">Leave Room</button>
        <button id="logoutBtn" class="btn btn-outline-danger btn-sm">Logout</button>
      </div>
    </div>

    <div class="row g-3">
      <div class="col-12 col-md-3">
        <div class="card shadow-sm">
          <div class="card-header fw-semibold">Members</div>
          <div class="card-body">
            <ul id="members" class="list-group list-group-flush"></ul>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-9">
        <div class="card shadow-sm">
          <div class="card-body">
            <div id="messages" class="border rounded p-3 mb-2"></div>
            <div id="typing" class="typing text-muted mb-2"></div>

            <div class="input-group">
              <input id="messageInput" class="form-control" placeholder="Type your message here..." />
              <button id="sendBtn" class="btn btn-primary">Send</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const userStr = localStorage.getItem("user");
    const room = localStorage.getItem("room");

    if (!userStr || !room) window.location.href = "/login";

    const user = JSON.parse(userStr);
    const me = user.username;

    document.getElementById("roomName").textContent = room;

    const messagesEl = document.getElementById("messages");
    const membersEl = document.getElementById("members");
    const typingEl = document.getElementById("typing");
    const inputEl = document.getElementById("messageInput");

    const socket = io();

    const addMessage = (m) => {
      const wrap = document.createElement("div");
      wrap.className = "msg" + (m.from_user === me ? " me" : "");

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = (m.from_user ? m.from_user : "System") + " â€¢ " + (m.date_sent || "");

      const text = document.createElement("div");
      text.textContent = m.message || "";

      wrap.appendChild(meta);
      wrap.appendChild(text);

      messagesEl.appendChild(wrap);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    };

    const renderMembers = (users) => {
      membersEl.innerHTML = "";
      users.forEach((u) => {
        const li = document.createElement("li");
        li.className = "list-group-item";
        li.textContent = u;
        membersEl.appendChild(li);
      });
    };

    socket.emit("joinRoom", { username: me, room });

    socket.on("roomUsers", (data) => {
      renderMembers(data.users || []);
    });

    socket.on("message", (m) => {
      addMessage(m);
    });

    let typingTimer = null;

    inputEl.addEventListener("input", () => {
      socket.emit("typing", { room, username: me });
      clearTimeout(typingTimer);
      typingTimer = setTimeout(() => socket.emit("stopTyping", { room, username: me }), 600);
    });

    socket.on("typing", (data) => {
      if (data.username && data.username !== me) typingEl.textContent = data.username + " is typing...";
    });

    socket.on("stopTyping", () => {
      typingEl.textContent = "";
    });

    const send = () => {
      const text = inputEl.value.trim();
      if (!text) return;
      socket.emit("chatMessage", { room, message: text });
      inputEl.value = "";
      socket.emit("stopTyping", { room, username: me });
    };

    document.getElementById("sendBtn").addEventListener("click", send);
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") send();
    });

    document.getElementById("leaveBtn").addEventListener("click", () => {
      socket.emit("leaveRoom");
      localStorage.removeItem("room");
      window.location.href = "/join";
    });

    document.getElementById("logoutBtn").addEventListener("click", () => {
      socket.emit("leaveRoom");
      localStorage.removeItem("room");
      localStorage.removeItem("user");
      window.location.href = "/login";
    });
  </script>
</body>
</html>
